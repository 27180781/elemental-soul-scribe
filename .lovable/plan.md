

# אופטימיזציית מהירות יצירת PDF

## הבעיה

התהליך הנוכחי איטי מאוד כי לכל משתתף:
1. נוצר אלמנט HTML מלא בזיכרון
2. `html2canvas` מצלם אותו ברזולוציה x3 (גודל: 2,382x3,369 פיקסלים!) - **הצוואר בקבוק העיקרי**
3. הקנבס מקודד ל-PNG (כבד, איטי)
4. התמונה מוכנסת ל-jsPDF

כל עמוד לוקח שניות רבות, ובהורדה מרוכזת של עשרות משתתפים זה יכול לקחת דקות.

## הפתרון: ציור ישיר עם jsPDF ללא html2canvas

במקום ליצור HTML, לצלם אותו, ולהמיר לתמונה - נצייר הכל ישירות על ה-PDF באמצעות פקודות jsPDF:
- **טקסט** (כותרות, שמות, אחוזים) -> `pdf.text()`
- **גרף העוגה** -> כבר מצויר על Canvas, נשתמש בו ישירות ב-JPEG
- **מסגרות, קווים** -> `pdf.rect()`, `pdf.line()`
- **Legend** -> ציור ישיר של ריבועים + טקסט

## שינויים עיקריים

### קובץ: `src/utils/pdfGenerator.ts`

**1. הסרת html2canvas לחלוטין**
- לא צריך יותר את `createProfileHTML` - לא יוצרים HTML בכלל
- לא צריך `html2canvas` (חיסכון גם בגודל ה-bundle)

**2. פונקציה חדשה `renderProfileToPDF` שמציירת ישירות על jsPDF**
```
renderProfileToPDF(pdf, profile, settings):
  1. כותרת "משתתף מספר X" -> pdf.text()
  2. שם המשתתף -> pdf.text()
  3. גרף עוגה -> create3DPieChart (Canvas -> JPEG -> pdf.addImage)
  4. Legend -> pdf.rect() + pdf.text() לכל יסוד
  5. תיבת אישיות -> pdf.rect() + pdf.text()
```

**3. אופטימיזציית גרף העוגה**
- הקטנת גודל ה-Canvas של העוגה (הוא כבר ברזולוציה גבוהה מידי)
- המרה ל-JPEG במקום PNG (מהיר x3-5, קובץ קטן יותר)
- `canvas.toDataURL('image/jpeg', 0.85)` במקום `'image/png'`

**4. עדכון `generatePDF` (הורדה בודדת)**
- קריאה ל-`renderProfileToPDF` במקום html2canvas

**5. עדכון `generateAllPDFs` (הורדה מרוכזת)**
- הסרת שלב יצירת HTML + הסרת html2canvas
- כל משתתף מצויר ישירות על ה-PDF
- העיבוד המקבילי יישאר לגרפי העוגה בלבד (יצירת canvas)

### תמיכה בעברית (RTL)
- jsPDF לא תומך ב-RTL מקורית, אז נשתמש בטריק של היפוך המחרוזות העבריות
- פונקציית עזר `reverseHebrew()` שהופכת טקסט עברי לתצוגה נכונה

## השוואת ביצועים צפויה

```text
לפני (הנוכחי):
  HTML -> html2canvas(scale:3) -> PNG -> jsPDF
  ~3-5 שניות למשתתף
  100 משתתפים = ~5-8 דקות

אחרי (מוצע):
  Canvas(pie) -> JPEG -> jsPDF draw commands
  ~0.1-0.3 שניות למשתתף
  100 משתתפים = ~10-30 שניות
```

## קבצים לעדכון

| קובץ | שינוי |
|------|-------|
| `src/utils/pdfGenerator.ts` | שכתוב מלא של לוגיקת הייצור - ציור ישיר על jsPDF |

## סיכונים ופתרונות

- **פונט Kanuba**: jsPDF לא תומך בפונטים מותאמים אישית בקלות. נשתמש ב-Arial/Helvetica כברירת מחדל, או נטמיע את הפונט כ-base64 אם נדרש
- **RTL**: נפתור עם היפוך מחרוזות ויישור לימין
- **מראה סופי**: עלול להיות שוני קל במראה לעומת הגרסה הנוכחית, אבל הפונקציונליות והמידע יהיו זהים

